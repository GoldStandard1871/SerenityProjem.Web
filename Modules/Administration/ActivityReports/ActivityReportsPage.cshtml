@{
    ViewData["Title"] = "Activity Reports";
}

@section Head
{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
}

<div id="ActivityReportsDiv" class="s-ActivityReportsPage">
    <div class="page-content">
        <div class="section-header">
            <h1><i class="fa fa-chart-line"></i> Activity Reports</h1>
            <p class="text-muted">Comprehensive user activity analysis and reporting</p>
        </div>

        <!-- Report Type Selector -->
        <div class="row mb-3">
            <div class="col-lg-12">
                <div class="widget-box transparent">
                    <div class="widget-header">
                        <h4 class="widget-title">
                            <i class="fa fa-filter"></i> Report Settings
                        </h4>
                    </div>
                    <div class="widget-body">
                        <div class="widget-main">
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Report Type:</label>
                                    <select id="reportType" class="form-control">
                                        <option value="daily">Daily Report</option>
                                        <option value="weekly" selected>Weekly Report</option>
                                        <option value="monthly">Monthly Report</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label>Date/Period:</label>
                                    <input type="date" id="reportDate" class="form-control" />
                                </div>
                                <div class="col-md-4">
                                    <label>&nbsp;</label><br>
                                    <button id="generateReport" class="btn btn-primary">
                                        <i class="fa fa-chart-bar"></i> Generate Report
                                    </button>
                                    <button id="exportReport" class="btn btn-success">
                                        <i class="fa fa-download"></i> Export
                                    </button>
                                    <button id="refreshReport" class="btn btn-info">
                                        <i class="fa fa-refresh"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center" style="display: none;">
            <i class="fa fa-spinner fa-spin fa-3x text-primary"></i>
            <p class="text-muted">Generating report...</p>
        </div>

        <!-- Report Summary Cards -->
        <div id="summaryCards" class="row mb-3" style="display: none;">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-primary">
                    <div class="stat-icon">
                        <i class="fa fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="uniqueUsers">0</div>
                        <div class="stat-text">Unique Users</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-success">
                    <div class="stat-icon">
                        <i class="fa fa-activity"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalActivities">0</div>
                        <div class="stat-text">Total Activities</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-info">
                    <div class="stat-icon">
                        <i class="fa fa-sign-in-alt"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalLogins">0</div>
                        <div class="stat-text">Total Logins</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-warning">
                    <div class="stat-icon">
                        <i class="fa fa-eye"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalPageViews">0</div>
                        <div class="stat-text">Page Views</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div id="chartsContainer" style="display: none;">
            <div class="row mb-3">
                <div class="col-lg-8">
                    <div class="widget-box transparent">
                        <div class="widget-header">
                            <h4 class="widget-title">
                                <i class="fa fa-chart-line"></i> Activity Trends
                            </h4>
                        </div>
                        <div class="widget-body">
                            <div class="widget-main">
                                <canvas id="activityTrendChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="widget-box transparent">
                        <div class="widget-header">
                            <h4 class="widget-title">
                                <i class="fa fa-pie-chart"></i> Activity Types
                            </h4>
                        </div>
                        <div class="widget-body">
                            <div class="widget-main">
                                <canvas id="activityTypeChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="row mb-3">
                <div class="col-lg-6">
                    <div class="widget-box transparent">
                        <div class="widget-header">
                            <h4 class="widget-title">
                                <i class="fa fa-clock"></i> Hourly Activity
                            </h4>
                        </div>
                        <div class="widget-body">
                            <div class="widget-main">
                                <canvas id="hourlyActivityChart" style="height: 250px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="widget-box transparent">
                        <div class="widget-header">
                            <h4 class="widget-title">
                                <i class="fa fa-users"></i> Top Active Users
                            </h4>
                        </div>
                        <div class="widget-body">
                            <div class="widget-main">
                                <canvas id="topUsersChart" style="height: 250px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Tables -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="widget-box transparent">
                        <div class="widget-header">
                            <h4 class="widget-title">
                                <i class="fa fa-list"></i> Top Pages
                            </h4>
                        </div>
                        <div class="widget-body">
                            <div class="widget-main">
                                <div class="table-responsive">
                                    <table id="topPagesTable" class="table table-striped table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Page</th>
                                                <th>Views</th>
                                                <th>Unique Viewers</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="widget-box transparent">
                        <div class="widget-header">
                            <h4 class="widget-title">
                                <i class="fa fa-user-friends"></i> User Activity Details
                            </h4>
                        </div>
                        <div class="widget-body">
                            <div class="widget-main">
                                <div class="table-responsive">
                                    <table id="userActivityTable" class="table table-striped table-bordered">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Activities</th>
                                                <th>First Activity</th>
                                                <th>Last Activity</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
    // Initialize date picker with today's date
    $('#reportDate').val(new Date().toISOString().split('T')[0]);
    
    // Event handlers
    $('#generateReport').click(generateReport);
    $('#refreshReport').click(generateReport);
    $('#exportReport').click(exportReport);
    $('#reportType').change(function() {
        updateDatePickerForType();
    });
    
    // Generate initial report
    generateReport();
});

let currentReportData = null;
let chartInstances = {};

function updateDatePickerForType() {
    const reportType = $('#reportType').val();
    const dateInput = $('#reportDate');
    
    if (reportType === 'monthly') {
        dateInput.attr('type', 'month');
    } else {
        dateInput.attr('type', 'date');
    }
}

function generateReport() {
    const reportType = $('#reportType').val();
    const reportDate = $('#reportDate').val();
    
    showLoading(true);
    hideReportContent();
    
    let apiUrl = '';
    let params = {};
    
    switch (reportType) {
        case 'daily':
            apiUrl = '/api/activity-reports/daily';
            if (reportDate) params.date = reportDate;
            break;
        case 'weekly':
            apiUrl = '/api/activity-reports/weekly';
            if (reportDate) params.startDate = reportDate;
            break;
        case 'monthly':
            apiUrl = '/api/activity-reports/monthly';
            if (reportDate) {
                const [year, month] = reportDate.split('-');
                params.year = parseInt(year);
                params.month = parseInt(month);
            }
            break;
    }
    
    $.get(apiUrl, params)
        .done(function(data) {
            currentReportData = data;
            displayReport(data, reportType);
            showLoading(false);
            showReportContent();
        })
        .fail(function(xhr, status, error) {
            showLoading(false);
            console.error('Report generation failed:', error);
            alert('Failed to generate report: ' + error);
        });
}

function displayReport(data, reportType) {
    // Update summary cards
    updateSummaryCards(data.Summary);
    
    // Create charts based on report type
    switch (reportType) {
        case 'daily':
            createDailyCharts(data);
            break;
        case 'weekly':
            createWeeklyCharts(data);
            break;
        case 'monthly':
            createMonthlyCharts(data);
            break;
    }
    
    // Update data tables
    updateDataTables(data);
}

function updateSummaryCards(summary) {
    $('#uniqueUsers').text(summary.UniqueUsers || 0);
    $('#totalActivities').text(summary.TotalActivities || 0);
    $('#totalLogins').text(summary.Logins || 0);
    $('#totalPageViews').text(summary.PageViews || 0);
}

function createDailyCharts(data) {
    // Hourly Activity Chart
    if (data.HourlyActivity && data.HourlyActivity.length > 0) {
        const hourlyLabels = data.HourlyActivity.map(h => h.Hour + ':00');
        const hourlyData = data.HourlyActivity.map(h => h.ActivityCount);
        
        createChart('hourlyActivityChart', {
            type: 'line',
            data: {
                labels: hourlyLabels,
                datasets: [{
                    label: 'Activities',
                    data: hourlyData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Hourly Activity Distribution'
                    }
                }
            }
        });
    }
    
    // Activity Types Pie Chart
    if (data.ActivityTypes && data.ActivityTypes.length > 0) {
        const typeLabels = data.ActivityTypes.map(t => t.ActivityType);
        const typeData = data.ActivityTypes.map(t => t.Count);
        
        createChart('activityTypeChart', {
            type: 'pie',
            data: {
                labels: typeLabels,
                datasets: [{
                    data: typeData,
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }
    
    // Top Users Chart
    if (data.TopUsers && data.TopUsers.length > 0) {
        const userLabels = data.TopUsers.map(u => u.Username);
        const userData = data.TopUsers.map(u => u.ActivityCount);
        
        createChart('topUsersChart', {
            type: 'bar',
            data: {
                labels: userLabels,
                datasets: [{
                    label: 'Activities',
                    data: userData,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Most Active Users'
                    }
                }
            }
        });
    }
}

function createWeeklyCharts(data) {
    // Daily Trends Chart
    if (data.DailyTrends && data.DailyTrends.length > 0) {
        const trendLabels = data.DailyTrends.map(d => new Date(d.Date).toLocaleDateString());
        const activityData = data.DailyTrends.map(d => d.ActivityCount);
        const userStrends = data.DailyTrends.map(d => d.UniqueUsers);
        
        createChart('activityTrendChart', {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Total Activities',
                    data: activityData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    yAxisID: 'y'
                }, {
                    label: 'Unique Users',
                    data: userStrends,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }
    
    // Peak Hours Chart
    if (data.PeakHours && data.PeakHours.length > 0) {
        const peakLabels = data.PeakHours.map(h => h.Hour + ':00');
        const peakData = data.PeakHours.map(h => h.ActivityCount);
        
        createChart('hourlyActivityChart', {
            type: 'bar',
            data: {
                labels: peakLabels,
                datasets: [{
                    label: 'Activities',
                    data: peakData,
                    backgroundColor: 'rgba(255, 206, 86, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Peak Hours This Week'
                    }
                }
            }
        });
    }
}

function createMonthlyCharts(data) {
    // Weekly Breakdown Chart
    if (data.WeeklyBreakdown && data.WeeklyBreakdown.length > 0) {
        const weekLabels = data.WeeklyBreakdown.map(w => 'Week ' + w.WeekNumber);
        const weekData = data.WeeklyBreakdown.map(w => w.ActivityCount);
        
        createChart('activityTrendChart', {
            type: 'bar',
            data: {
                labels: weekLabels,
                datasets: [{
                    label: 'Activities',
                    data: weekData,
                    backgroundColor: 'rgba(153, 102, 255, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Weekly Activity Breakdown'
                    }
                }
            }
        });
    }
    
    // User Segmentation Chart
    if (data.UserSegmentation && data.UserSegmentation.length > 0) {
        const segmentLabels = data.UserSegmentation.map(s => s.Segment);
        const segmentData = data.UserSegmentation.map(s => s.UserCount);
        
        createChart('activityTypeChart', {
            type: 'doughnut',
            data: {
                labels: segmentLabels,
                datasets: [{
                    data: segmentData,
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB', 
                        '#FFCE56',
                        '#4BC0C0'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'User Activity Segmentation'
                    }
                }
            }
        });
    }
}

function createChart(canvasId, config) {
    // Destroy existing chart if it exists
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }
    
    const ctx = document.getElementById(canvasId).getContext('2d');
    chartInstances[canvasId] = new Chart(ctx, config);
}

function updateDataTables(data) {
    // Update Top Pages table
    if (data.PageViews && data.PageViews.length > 0) {
        const pageTableBody = $('#topPagesTable tbody');
        pageTableBody.empty();
        
        data.PageViews.forEach(page => {
            pageTableBody.append(`
                <tr>
                    <td>${page.ActivityDetail || 'N/A'}</td>
                    <td><span class="badge badge-info">${page.ViewCount}</span></td>
                    <td><span class="badge badge-success">${page.UniqueViewers}</span></td>
                </tr>
            `);
        });
    }
    
    // Update User Activity table
    if (data.TopUsers && data.TopUsers.length > 0) {
        const userTableBody = $('#userActivityTable tbody');
        userTableBody.empty();
        
        data.TopUsers.forEach(user => {
            const firstActivity = new Date(user.FirstActivity).toLocaleString();
            const lastActivity = new Date(user.LastActivity).toLocaleString();
            
            userTableBody.append(`
                <tr>
                    <td><strong>${user.Username}</strong></td>
                    <td><span class="badge badge-primary">${user.ActivityCount}</span></td>
                    <td><small>${firstActivity}</small></td>
                    <td><small>${lastActivity}</small></td>
                </tr>
            `);
        });
    }
}

function showLoading(show) {
    if (show) {
        $('#loadingIndicator').show();
    } else {
        $('#loadingIndicator').hide();
    }
}

function showReportContent() {
    $('#summaryCards').show();
    $('#chartsContainer').show();
}

function hideReportContent() {
    $('#summaryCards').hide();
    $('#chartsContainer').hide();
}

function exportReport() {
    if (!currentReportData) {
        alert('No report data to export. Please generate a report first.');
        return;
    }
    
    const reportType = $('#reportType').val();
    const reportDate = $('#reportDate').val();
    
    // Show export options
    const exportOptions = `
        <div class="modal fade" id="exportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Export Report</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Export Format:</label>
                            <select id="exportFormat" class="form-control">
                                <option value="csv">CSV (Excel Compatible)</option>
                                <option value="html">HTML Report</option>
                                <option value="json">JSON Data</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="scheduleReport"> Schedule this report
                            </label>
                        </div>
                        <div id="scheduleOptions" style="display:none;">
                            <div class="form-group">
                                <label>Frequency:</label>
                                <select id="scheduleFrequency" class="form-control">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Email Address:</label>
                                <input type="email" id="scheduleEmail" class="form-control" placeholder="admin@company.com">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="performExport()">Export</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal and add new one
    $('#exportModal').remove();
    $('body').append(exportOptions);
    
    // Show modal
    $('#exportModal').modal('show');
    
    // Handle schedule checkbox
    $('#scheduleReport').change(function() {
        if ($(this).is(':checked')) {
            $('#scheduleOptions').show();
        } else {
            $('#scheduleOptions').hide();
        }
    });
}

function performExport() {
    const reportType = $('#reportType').val();
    const reportDate = $('#reportDate').val();
    const exportFormat = $('#exportFormat').val();
    const scheduleReport = $('#scheduleReport').is(':checked');
    
    // Debug log
    console.log('Export parameters:', { reportType, reportDate, exportFormat });
    
    // Validate required fields
    if (!reportType) {
        alert('Please select a report type first.');
        return;
    }
    
    if (!reportDate) {
        alert('Please select a date first.');
        return;
    }
    
    if (!currentReportData) {
        alert('No report data available. Please generate a report first.');
        return;
    }
    
    if (scheduleReport) {
        const frequency = $('#scheduleFrequency').val();
        const email = $('#scheduleEmail').val();
        
        if (!email) {
            alert('Please enter an email address for scheduled reports.');
            return;
        }
        
        // Schedule the report
        $.post('/api/activity-reports/schedule', {
            reportType: reportType,
            frequency: frequency,
            email: email
        })
        .done(function(result) {
            if (result.Success) {
                alert(`Report scheduled successfully! Next run: ${new Date(result.ScheduledReport.NextRun).toLocaleString()}`);
                $('#exportModal').modal('hide');
            } else {
                alert('Failed to schedule report: ' + result.Error);
            }
        })
        .fail(function() {
            alert('Failed to schedule report. Please try again.');
        });
    }
    
    // Perform the export
    if (exportFormat === 'json') {
        // JSON export (client-side)
        const exportData = {
            reportType: reportType,
            reportDate: reportDate,
            generatedAt: new Date().toISOString(),
            data: currentReportData
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `activity-report-${reportType}-${reportDate}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        $('#exportModal').modal('hide');
    } else {
        // Server-side export (CSV/HTML)
        const exportUrl = `/api/activity-reports/export/csv?reportType=${encodeURIComponent(reportType)}&reportDate=${encodeURIComponent(reportDate)}&format=${encodeURIComponent(exportFormat)}`;
        
        console.log('Export URL:', exportUrl);
        
        // Create a temporary form to trigger download
        const form = $('<form method="GET" action="' + exportUrl + '"></form>');
        $('body').append(form);
        form.submit();
        form.remove();
        
        $('#exportModal').modal('hide');
    }
}
</script>

<style>
.stat-card {
    padding: 20px;
    border-radius: 8px;
    color: white;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-icon {
    font-size: 2.5em;
    margin-right: 15px;
    opacity: 0.8;
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-text {
    font-size: 0.9em;
    opacity: 0.9;
}

.widget-box {
    background: white;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.widget-header {
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    background: #f8f9fa;
}

.widget-title {
    margin: 0;
    font-size: 1.1em;
    color: #333;
}

.widget-body {
    padding: 0;
}

.widget-main {
    padding: 20px;
}

.table-responsive {
    max-height: 300px;
    overflow-y: auto;
}

.badge {
    font-size: 0.8em;
}
</style>